<!-- 
  Partial: Ticket de Pago - Preview
  Mobile-first, responsive, formato A4 para impresión
  @author Dante Marcos Delprato
  @version 1.0
-->

<div id="ticket-container" class="ticket-container">
  <% 
    // Configuración de paginación
    const CONCEPTOS_POR_PAGINA = municipalidad.ticket.conceptosPorPagina || 15;
    const totalPaginas = Math.ceil(conceptos.length / CONCEPTOS_POR_PAGINA);
    
    // Función helper para calcular subtotal de una página
    function calcularSubtotalPagina(items) {
      return items.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
    }
  %>

  <% for (let pagina = 0; pagina < totalPaginas; pagina++) { %>
  <% 
      const inicio = pagina * CONCEPTOS_POR_PAGINA;
      const fin = Math.min(inicio + CONCEPTOS_POR_PAGINA, conceptos.length);
      const conceptosPagina = conceptos.slice(inicio, fin);
      
      // Calcular subtotales de la página para cada columna
      const subtotalImportePagina = conceptosPagina.reduce((sum, item) => sum + parseFloat(item.importeNumerico || 0), 0);
      const subtotalInteresPagina = conceptosPagina.reduce((sum, item) => sum + parseFloat(item.interesNumerico || 0), 0);
      const subtotalTotalPagina = conceptosPagina.reduce((sum, item) => sum + parseFloat(item.totalNumerico || 0), 0);
      
      const esUltimaPagina = pagina === totalPaginas - 1;
    %>

  <div class="ticket-page" data-page="<%= pagina + 1 %>">
    <!-- HEADER -->
    <header class="ticket-header">
      <!-- Primera línea: Logo, Nombre Municipalidad, Fecha -->
      <div class="ticket-header-top">
        <div class="ticket-logo">
          <img src="<%= municipalidad.logos.principal %>" alt="Logo <%= municipalidad.nombre %>" class="ticket-logo-img">
        </div>
        <div class="ticket-title">
          <h1><%= municipalidad.nombreCompleto %></h1>
          <!-- <p class="ticket-subtitle"><%= municipalidad.ticket.encabezado || 'Comprobante de Pago' %></p> -->
        </div>
        <div class="ticket-fecha">
          <p class="ticket-fecha-label">Fecha de Emisión:</p>
          <p class="ticket-fecha-valor"><%= fechaEmision %></p>
        </div>
      </div>

      <!-- Segunda línea: Dirección y datos de contacto del Municipio -->
      <div class="ticket-header-info">
        <div class="ticket-direccion">
          <p><strong>Dirección:</strong> <%= municipalidad.direccion %>, <%= municipalidad.localidad %>, <%= municipalidad.provincia %> </p>
          <p><strong>CP:</strong> <%= municipalidad.codigoPostal %> </p>
          <p><strong>Tel:</strong> <%= municipalidad.telefono %></p>
        </div>
      </div>

      <!-- Tercera línea: Datos del contribuyente -->
      <div class="ticket-contribuyente">
        <p><strong>Contribuyente:</strong> <%= contribuyente.nombreCompleto %></p>
        <p><strong>DNI:</strong> <%= contribuyente.dni %></p>
      </div>
    </header>

    <!-- TABLA DE CONCEPTOS -->
    <div class="ticket-body">
      <% if (pagina === 0 || esUltimaPagina) { %>
      <div class="ticket-resumen" style="font-size: x-small; margin: 0.25rem 0; color:#000;">
        Conceptos en ticket: <strong><%= conceptos.length %></strong>
      </div>
      <% } %>
      <table class="ticket-table">
        <thead>
          <tr>
            <th>Fecha Vto.</th>
            <th>Detalle</th>
            <th>Cuota</th>
            <th>Año</th>
            <th class="ticket-col-right">Importe</th>
            <th class="ticket-col-right">Int/Dto</th>
            <th class="ticket-col-right">Total</th>
          </tr>
        </thead>
        <tbody>
          <% conceptosPagina.forEach((concepto, idx) => { %>
          <tr>
            <td><%= concepto.fechaVto %></td>
            <td class="ticket-detalle">
              <%= concepto.tipoDescripcion %><% if (concepto.detalle) { %> - <%= concepto.detalle %><% } %>
            </td>
            <td><%= concepto.cuota || '-' %></td>
            <td><%= concepto.anio || '-' %></td>
            <td class="ticket-col-right">$ <%= concepto.importe %></td>
            <td class="ticket-col-right <%= concepto.interesClase %>">
              $ <%= concepto.interes %>
            </td>
            <td class="ticket-col-right"><strong>$ <%= concepto.total %></strong></td>
          </tr>
          <% }) %>
        </tbody>
        <tfoot>
          <tr class="ticket-subtotal-row">
            <td colspan="4" class="ticket-col-right"><strong>Subtotal Pág. <%= pagina + 1 %>:</strong></td>
            <td class="ticket-col-right"><strong>$ <%= subtotalImportePagina.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong></td>
            <td class="ticket-col-right <%= subtotalInteresPagina >= 0 ? 'interes-negativo' : 'descuento-positivo' %>"><strong>$ <%= Math.abs(subtotalInteresPagina).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong></td>
            <td class="ticket-col-right"><strong>$ <%= subtotalTotalPagina.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong></td>
          </tr>
          <% if (esUltimaPagina) { %>
          <tr class="ticket-total-row">
            <td colspan="7" style="text-align: center;"><strong>TOTAL A PAGAR: $ <%= totalGeneral %></strong></td>
          </tr>
          <% } %>
        </tfoot>
      </table>
    </div>

    <!-- FOOTER -->
    <footer class="ticket-footer">
      <div class="ticket-validez">
        <p><strong>⚠️ IMPORTANTE:</strong> <%= municipalidad.ticket.mensajeValidez %></p>
      </div>
      <% if (municipalidad.ticket.piePagina) { %>
      <div class="ticket-nota">
        <p><em><%= municipalidad.ticket.piePagina %></em></p>
      </div>
      <% } %>
      <div class="ticket-paginacion">
        <p>Página <%= pagina + 1 %> de <%= totalPaginas %></p>
      </div>
    </footer>
  </div>

  <% if (!esUltimaPagina) { %>
  <div class="ticket-page-break"></div>
  <% } %>
  <% } %>
</div>