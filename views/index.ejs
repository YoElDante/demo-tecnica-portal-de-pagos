<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/webp" href="<%= municipalidad.logos.principal %>">

  <!-- Fuentes Google (consistentes con sitio oficial ALCALD+IA) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Estilos principales del portal -->
  <link rel="stylesheet" href="/stylesheets/styles.css">
  <!-- Estilos del componente Ticket (independiente) -->
  <link rel="stylesheet" href="/stylesheets/ticket.css">

  <!-- Librer√≠a para generaci√≥n de PDF vectorial -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="/javascripts/deudas.js" defer></script>
  <title><%= title %> - <%= municipalidad.nombre %></title>
</head>

<body>
  <!-- ============================================
       HEADER
       ============================================ -->
  <header class="header">
    <div class="header__logo">
      <img src="<%= municipalidad.logos.principal %>" alt="Logo <%= municipalidad.nombre %>" class="header__logo-img">
    </div>
    <div class="header__title">
      <h2>Portal de Pago<br><%= municipalidad.nombreCompleto %></h2>
    </div>
    <div class="header__icon">
      <img src="<%= municipalidad.logos.secundario %>" alt="Logo Alcald+IA" class="header__icon-img">
    </div>
  </header>

  <!-- ============================================
       CONTENIDO PRINCIPAL
       ============================================ -->
  <main class="main">
    <!-- Formulario de b√∫squeda -->
    <section class="form">
      <h1 class="form__title">Sistema de Pago Online</h1>
      <br>
      <h2 class="form__subtitle">Datos del Contribuyente</h2>

      <form action="/buscar" method="POST" class="form__content">
        <div class="form__group">
          <label for="dni" class="form__label">DNI (7-10 d√≠gitos)</label>
          <div class="form__input-wrapper">
            <input type="text" id="dni" name="dni" pattern="\d{7,10}" minlength="7" maxlength="10" title="El DNI debe tener entre 7 y 10 n√∫meros" placeholder="Ingrese su n√∫mero de DNI" value="<%= typeof dni !== 'undefined' ? dni : '' %>" required oninput="this.value = this.value.replace(/[^0-9]/g, '')" class="form__input">
            <button type="submit" class="btn btn--search">Buscar</button>
          </div>
          <% if (typeof mensaje !== 'undefined' && mensaje) { %>
          <span class="form__error"><%= mensaje %></span>
          <% } %>
        </div>

        <div class="form__group">
          <label for="nombre" class="form__label">Nombre Completo</label>
          <input type="text" id="nombre" name="nombre" value="<%= clienteNoEncontrado ? 'Contribuyente no encontrado' : (cliente ? (cliente.Nombre + ' ' + cliente.Apellido) : '') %>" placeholder="Nombre del contribuyente" class="form__input <%= clienteNoEncontrado ? 'form__input--not-found' : '' %>" readonly>
        </div>
      </form>
    </section>

    <!-- Tabla de deudas -->
    <% if (typeof deudas !== 'undefined') { %>
    <section class="deudas">
      <h2 class="deudas__title">Detalle de Boletas</h2>
      <p class="deudas__subtitle">Seleccione los conceptos a abonar:</p>

      <% const TIPO_DESCRIPCIONES = typeof tipoDescripciones !== 'undefined' ? tipoDescripciones : {}; %>
      <% const TIPO_ICONOS = typeof tipoIconos !== 'undefined' ? tipoIconos : {}; %>

      <div class="deudas__filter">
        <label for="filtro-tipo" class="deudas__filter-label">Filtrar por Tipo:</label>
        <% if ((tiposDeuda || []).length === 0) { %>
        <small class="deudas__filter-empty">No hay tipos diferenciados en esta b√∫squeda.</small>
        <% } %>
        <select id="filtro-tipo" class="deudas__filter-select">
          <option value="">Todas</option>
          <% (tiposDeuda || []).forEach(t => { %>
          <option value="<%= t %>"><%= TIPO_ICONOS[t] %> <%= TIPO_DESCRIPCIONES[t] || t %></option>
          <% }) %>
        </select>
      </div>

      <div id="resumen-deudas" class="deudas__summary">
        Deudas: <span id="contador-deudas-total"><%= (deudas || []).length %></span> |
        Seleccionadas: <span id="contador-deudas-seleccionadas"><%= (deudas || []).length %></span>
      </div>

      <div class="deudas__wrapper">
        <table class="deudas__table">
          <thead>
            <tr class="deudas__row--select-all">
              <th style="text-align: center;">
                <input type="checkbox" id="checkbox-todos" class="deudas__checkbox" checked>
              </th>
              <th colspan="7" style="text-align: left; padding-left: 1rem;">
                <label for="checkbox-todos">
                  Seleccionar/Deseleccionar Todo
                </label>
              </th>
            </tr>
            <tr>
              <th style="width: 50px;">Elija</th>
              <th>Fecha Vto</th>
              <th>Detalle</th>
              <th>Cuota</th>
              <th>A√±o</th>
              <th>Importe H.</th>
              <th>Int/Dto</th>
              <th>Total</th>
            </tr>
          </thead>

          <tbody>
            <% if ((deudas || []).length === 0) { %>
            <tr>
              <td colspan="8" class="deudas__empty">No tiene deudas pendientes.</td>
            </tr>
            <% } %>
            <% (deudas || []).forEach((deuda, index) => { %>
            <tr data-tipo="<%= deuda.Tipo %>" data-idtrans="<%= deuda.IdTrans %>">
              <td style="text-align: center;">
                <input type="checkbox" class="deudas__checkbox" data-total="<%= deuda.Total %>" data-idtrans="<%= deuda.IdTrans %>" checked>
              </td>
              <td><%= deuda.FechaVto ? new Date(deuda.FechaVto).toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '-' %></td>
              <td><span class="deudas__type-icon"><%= deuda.TipoIcono %></span><%= deuda.TipoDescripcion %><% if (deuda.Detalle) { %> - <%= deuda.Detalle %><% } %></td>
              <td><%= deuda.Cuota || '-' %></td>
              <td><%= deuda.Anio || '-' %></td>
              <td>$ <%= deuda.Importe.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
              <td class="<%= deuda.Interes >= 0 ? 'deudas__value--interest' : 'deudas__value--discount' %>">
                <%= deuda.Interes < 0 ? '-' : '' %>$ <%= Math.abs(deuda.Interes).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
              </td>
              <td>$ <%= deuda.Total.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
            </tr>
            <% }) %>
          </tbody>

          <tfoot>
            <tr class="deudas__row--total">
              <td colspan="7" style="text-align: right;"><strong>Total a Pagar:</strong></td>
              <td><strong id="total-final" class="deudas__total">$ <%= totalGeneral ? totalGeneral.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '0,00' %></strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
    <% } %>

    <!-- Botones de acci√≥n -->
    <% if (deudas && deudas.length > 0) { %>
    <section class="actions">
      <button class="btn btn--ticket btn--generate" id="btn-generar-ticket">
        üìÑ Generar Ticket
      </button>
      <button class="btn btn--ticket btn--download" id="btn-descargar-pdf" disabled>
        üíæ Descargar PDF
      </button>
      <button class="btn btn--qr" id="generate-qr" onclick="mostrarQR()">
        üì± Generar QR
      </button>
    </section>

    <!-- Contenedor para preview del ticket -->
    <div id="ticket-preview-container" style="display: none;">
      <!-- El ticket se cargar√° aqu√≠ din√°micamente -->
    </div>

    <!-- Botones de acci√≥n POST-TICKET (aparecen despu√©s de generar el ticket) -->
    <section class="actions actions--bottom" id="ticket-actions-bottom" style="display: none;">
      <button class="btn btn--ticket btn--download" id="btn-descargar-pdf-bottom">
        üíæ Descargar PDF
      </button>
      <button class="btn btn--qr" id="generate-qr-bottom" onclick="mostrarQR()">
        üì± Generar QR
      </button>
      <button class="btn btn--ticket btn--back" id="btn-volver-arriba" onclick="volverArriba()">
        ‚¨ÜÔ∏è Volver Arriba
      </button>
    </section>
    <% } %>

    <!-- Contenedor del c√≥digo QR y bot√≥n de pago -->
    <div class="qr" id="qr-container" style="display:none;">
      <img class="qr__image" id="qr-image" src="/images/qr_mercado.webp" alt="QR Code" />
      <button id="pay-button" class="btn btn--ticket btn--pay" onclick="iniciarPagoMercadoPago()">
        üí≥ Ir a Pagar con MercadoPago
      </button>
      <p id="pago-loading" class="qr__loading" style="display:none;">‚è≥ Procesando pago...</p>
    </div>

    <!-- Bot√≥n Generar QR (se oculta despu√©s de generarlo) -->
    <% if (deudas && deudas.length > 0 && false) { %>
    <section class="actions">
      <button class="btn btn--qr" id="generate-qr-old" onclick="mostrarQR()">Generar QR</button>
    </section>
    <% } %>
  </main>

  <script>
    // Datos del contribuyente desde el servidor
    const contribuyenteData = {
      dni: '<%= cliente ? cliente.Codigo : "" %>',
      nombre: '<%= cliente ? (cliente.Nombre + " " + cliente.Apellido).trim() : "" %>',
      email: '<%= cliente ? (cliente.Email || "") : "" %>'
    };

    function mostrarQR() {
      const qrContainer = document.getElementById('qr-container');
      const qrImage = document.getElementById('qr-image');
      const payButton = document.getElementById('pay-button');

      // Mostrar contenedor con QR y bot√≥n de pagar
      qrContainer.style.display = 'flex';
      qrImage.style.display = 'block';
      payButton.style.display = 'block';

      // Scroll suave al QR
      setTimeout(() => {
        qrContainer.scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
      }, 100);
    }

    /**
     * Recopila los IDs de transacci√≥n de las deudas seleccionadas
     * @returns {Array<number>} Array de IdTrans seleccionados
     */
    function recopilarIdTransSeleccionados() {
      const checkboxes = document.querySelectorAll('.deudas__checkbox:checked');
      const ids = [];

      checkboxes.forEach(cb => {
        const fila = cb.closest('tr');
        if (fila && fila.style.display !== 'none') {
          const idTrans = parseInt(cb.dataset.idtrans);
          if (idTrans) ids.push(idTrans);
        }
      });

      return ids;
    }

    /**
     * Inicia el proceso de pago con MercadoPago
     */
    async function iniciarPagoMercadoPago() {
      const payButton = document.getElementById('pay-button');
      const loadingMsg = document.getElementById('pago-loading');

      // Recopilar conceptos seleccionados
      const conceptosIds = recopilarIdTransSeleccionados();

      if (conceptosIds.length === 0) {
        alert('Por favor, seleccione al menos un concepto para pagar.');
        return;
      }

      // Obtener el total desde la UI
      const totalElement = document.getElementById('total-final');
      const totalText = totalElement?.textContent.replace(/[^\d,.-]/g, '').replace(',', '.') || '0';
      const montoTotal = parseFloat(totalText);

      if (montoTotal <= 0) {
        alert('El monto total debe ser mayor a cero.');
        return;
      }

      // Recopilar conceptos con detalle para el API
      const conceptos = recopilarConceptosParaPago();

      // Mostrar loading
      payButton.disabled = true;
      payButton.style.display = 'none';
      loadingMsg.style.display = 'block';

      try {
        const response = await fetch('/pago/iniciar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            contribuyente: contribuyenteData,
            conceptos: conceptos,
            montoTotal: montoTotal
          })
        });

        const data = await response.json();

        if (data.success && data.redirect_url) {
          // Redirigir a MercadoPago
          window.location.href = data.redirect_url;
        } else {
          throw new Error(data.message || 'Error al iniciar el pago');
        }
      } catch (error) {
        console.error('Error al iniciar pago:', error);
        alert('Error al procesar el pago: ' + error.message);

        // Restaurar bot√≥n
        payButton.disabled = false;
        payButton.style.display = 'block';
        loadingMsg.style.display = 'none';
      }
    }

    /**
     * Recopila los conceptos seleccionados con formato para el API
     * @returns {Array} Array de conceptos para enviar al backend
     */
    function recopilarConceptosParaPago() {
      const checkboxes = document.querySelectorAll('.deudas__checkbox:checked');
      const conceptos = [];

      checkboxes.forEach(cb => {
        const fila = cb.closest('tr');
        if (fila && fila.style.display !== 'none') {
          const celdas = fila.querySelectorAll('td');
          const idTrans = parseInt(cb.dataset.idtrans);
          const total = parseFloat(cb.dataset.total || '0');

          // Extraer descripci√≥n del concepto
          const detalleCell = celdas[2];
          const descripcion = detalleCell ? detalleCell.textContent.trim() : 'Concepto';

          conceptos.push({
            id: idTrans,
            descripcion: descripcion,
            monto: total
          });
        }
      });

      return conceptos;
    }

    function volverArriba() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
  </script>


  <!-- ============================================
       FOOTER
       ============================================ -->
  <footer class="footer">
    <p class="footer__text">&copy; Power by Alcald+IA. Todos los derechos reservados.</p>
  </footer>

</body>

</html>